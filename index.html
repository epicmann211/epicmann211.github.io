<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>WebXR Gorilla-Tag Arm Locomotion Fixed</title>
<style>
  body,html { margin:0; padding:0; overflow:hidden; background:#000; }
  canvas { width:100%; height:100%; display:block; }
</style>
</head>
<body>
<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js';
import { VRButton } from 'https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/webxr/VRButton.js';
import { XRControllerModelFactory } from 'https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/webxr/XRControllerModelFactory.js';

let scene, camera, renderer;
let player, leftHand, rightHand;
let prevLeftPos = null, prevRightPos = null;
const speed = 0.1;

init();

function init(){
    // Renderer & Scene
    renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    document.body.appendChild(VRButton.createButton(renderer));

    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x222222);

    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(0,1.6,3);

    const light = new THREE.HemisphereLight(0xffffff,0x444444,1);
    scene.add(light);

    // Ground
    const ground = new THREE.Mesh(
        new THREE.PlaneGeometry(20,20),
        new THREE.MeshStandardMaterial({color:0x333333})
    );
    ground.rotation.x = -Math.PI/2;
    scene.add(ground);

    // Player capsule
    const playerGeo = new THREE.CapsuleGeometry(0.35,1.0,4,8);
    const playerMat = new THREE.MeshStandardMaterial({color:0x00ff00});
    player = new THREE.Mesh(playerGeo, playerMat);
    player.position.y = 1;
    scene.add(player);

    // Hands
    const handGeo = new THREE.SphereGeometry(0.15,16,16);
    const leftMat = new THREE.MeshStandardMaterial({color:0xff0000});
    const rightMat = new THREE.MeshStandardMaterial({color:0x0000ff});
    leftHand = new THREE.Mesh(handGeo, leftMat);
    rightHand = new THREE.Mesh(handGeo, rightMat);
    scene.add(leftHand);
    scene.add(rightHand);

    // XR Controllers
    const controller1 = renderer.xr.getController(0);
    const controller2 = renderer.xr.getController(1);
    scene.add(controller1);
    scene.add(controller2);

    const controllerModelFactory = new XRControllerModelFactory();
    const grip1 = renderer.xr.getControllerGrip(0);
    grip1.add(controllerModelFactory.createControllerModel(grip1));
    scene.add(grip1);

    const grip2 = renderer.xr.getControllerGrip(1);
    grip2.add(controllerModelFactory.createControllerModel(grip2));
    scene.add(grip2);

    // Animation Loop
    renderer.setAnimationLoop(update);
    window.addEventListener('resize',()=>renderer.setSize(window.innerWidth, window.innerHeight));

    function update(){
        // Update hand positions
        leftHand.position.copy(grip1.position);
        rightHand.position.copy(grip2.position);

        // Simple arm-swing locomotion if hands touch ground
        [ ['left', leftHand, prevLeftPos], ['right', rightHand, prevRightPos] ].forEach(([handName, hand, prevPos])=>{
            const touching = hand.position.y <= 0.18;
            if(touching && prevPos){
                const delta = hand.position.clone().sub(prevPos);
                player.position.x += delta.x * speed;
                player.position.z += delta.z * speed;
            }
            if(handName==='left') prevLeftPos = hand.position.clone();
            else prevRightPos = hand.position.clone();
        });

        camera.position.x = player.position.x;
        camera.position.z = player.position.z;
        camera.position.y = player.position.y + 0.6;

        renderer.render(scene, camera);
    }
}
</script>
</body>
</html>
