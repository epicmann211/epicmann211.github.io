<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>WebXR Gorilla Locomotion</title>
<style>
    html, body { width: 100%; height: 100%; margin: 0; overflow: hidden; }
    canvas { width: 100%; height: 100%; display: block; }
</style>
<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
</head>

<body>
<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const engine = new BABYLON.Engine(canvas, true);
const scene = new BABYLON.Scene(engine);

scene.createDefaultEnvironment({ enableGroundShadow: true });

const camera = new BABYLON.FreeCamera("cam", new BABYLON.Vector3(0, 1.6, 0), scene);
camera.setTarget(BABYLON.Vector3.Zero());

// Physics
scene.enablePhysics(new BABYLON.Vector3(0, -9.81, 0), new BABYLON.AmmoJSPlugin());

// -------------------------
// PLAYER BODY (capsule)
// -------------------------
const bodyHeight = 1.2;
const body = BABYLON.MeshBuilder.CreateCapsule("player", {
    height: bodyHeight,
    radius: 0.35
}, scene);
body.position.y = 1.0;

body.physicsImpostor = new BABYLON.PhysicsImpostor(
    body,
    BABYLON.PhysicsImpostor.CapsuleImpostor,
    { mass: 60, friction: 0.1, restitution: 0 },
    scene
);

// -------------------------
// XR
// -------------------------
const xrHelper = await BABYLON.WebXRDefaultExperience.CreateAsync(scene);
xrHelper.teleportation.dispose(); // REMOVE TELEPORTATION
xrHelper.pointerSelection.detach(); // No ray laser

let leftController = null;
let rightController = null;

// Track last hand positions
let lastLeftPos = null;
let lastRightPos = null;

xrHelper.input.onControllerAddedObservable.add(controller => {
    if (controller.inputSource.handedness === "left") leftController = controller;
    if (controller.inputSource.handedness === "right") rightController = controller;
});

// -------------------------
// ARM-SWING MOVEMENT
// -------------------------
scene.onBeforeRenderObservable.add(() => {
    const dt = engine.getDeltaTime() / 1000;

    if (!xrHelper.baseExperience.state === BABYLON.WebXRState.IN_XR) return;

    let movement = new BABYLON.Vector3(0, 0, 0);

    // Left hand swing
    if (leftController && leftController.grip) {
        const pos = leftController.grip.position.clone();
        if (lastLeftPos) {
            const velocity = pos.subtract(lastLeftPos).scale(5);
            movement.addInPlace(velocity);
        }
        lastLeftPos = pos.clone();
    }

    // Right hand swing
    if (rightController && rightController.grip) {
        const pos = rightController.grip.position.clone();
        if (lastRightPos) {
            const velocity = pos.subtract(lastRightPos).scale(5);
            movement.addInPlace(velocity);
        }
        lastRightPos = pos.clone();
    }

    // Physics push
    body.physicsImpostor.applyImpulse(
        new BABYLON.Vector3(movement.x, 0, movement.z),
        body.getAbsolutePosition()
    );

    // Attach camera to body position
    camera.position = body.getAbsolutePosition().add(new BABYLON.Vector3(0, bodyHeight / 2, 0));
});

engine.runRenderLoop(() => scene.render());
</script>
</body>
</html>
