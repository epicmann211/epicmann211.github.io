<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Gorilla Tag Inspired VR</title>
<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/cannon.js"></script>
<script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
</head>
<body style="margin:0; overflow:hidden;">
<canvas id="renderCanvas"></canvas>
<script>
window.addEventListener('DOMContentLoaded', async function() {
    const canvas = document.getElementById('renderCanvas');
    const engine = new BABYLON.Engine(canvas, true);

    const scene = new BABYLON.Scene(engine);
    scene.clearColor = new BABYLON.Color3(0.5, 0.8, 0.95);
    
    // Physics
    scene.enablePhysics(new BABYLON.Vector3(0, -9.81, 0), new BABYLON.CannonJSPlugin());

    // Camera (used for debugging in non-VR)
    const camera = new BABYLON.UniversalCamera("cam", new BABYLON.Vector3(0,2,-5), scene);
    camera.attachControl(canvas, true);

    // Light
    const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0,1,0), scene);

    // Ground
    const ground = BABYLON.MeshBuilder.CreateGround("ground",{width:50, height:50},scene);
    ground.physicsImpostor = new BABYLON.PhysicsImpostor(ground, BABYLON.PhysicsImpostor.BoxImpostor, {mass:0, friction:0.5, restitution:0}, scene);
    ground.material = new BABYLON.StandardMaterial("groundMat",scene);
    ground.material.diffuseColor = new BABYLON.Color3(0.3,0.6,0.3);

    // Player capsule made of faces
    const player = new BABYLON.TransformNode("player", scene);
    const head = BABYLON.MeshBuilder.CreateBox("head",{size:0.5},scene);
    head.position.y = 1.75;
    head.parent = player;
    head.material = new BABYLON.StandardMaterial("headMat",scene);
    head.material.diffuseColor = new BABYLON.Color3(0.8,0.7,0.5);

    const body = BABYLON.MeshBuilder.CreateBox("body",{width:0.6, height:1, depth:0.3},scene);
    body.position.y = 1;
    body.parent = player;
    body.material = new BABYLON.StandardMaterial("bodyMat",scene);
    body.material.diffuseColor = new BABYLON.Color3(0.7,0.2,0.2);

    // Arm placeholders
    const leftArm = BABYLON.MeshBuilder.CreateBox("leftArm",{width:0.15, height:0.7, depth:0.15},scene);
    leftArm.position.set(-0.45,1.5,0);
    leftArm.parent = player;
    leftArm.material = new BABYLON.StandardMaterial("leftMat",scene);
    leftArm.material.diffuseColor = new BABYLON.Color3(0.8,0.7,0.5);

    const rightArm = BABYLON.MeshBuilder.CreateBox("rightArm",{width:0.15, height:0.7, depth:0.15},scene);
    rightArm.position.set(0.45,1.5,0);
    rightArm.parent = player;
    rightArm.material = new BABYLON.StandardMaterial("rightMat",scene);
    rightArm.material.diffuseColor = new BABYLON.Color3(0.8,0.7,0.5);

    // Physics impostor for player
    player.physicsImpostor = new BABYLON.PhysicsImpostor(body, BABYLON.PhysicsImpostor.BoxImpostor, {mass:1, friction:0.5, restitution:0}, scene);

    // WebXR experience
    const xrHelper = await scene.createDefaultXRExperienceAsync({
        floorMeshes: [ground]
    });

    // Arm-swing locomotion
    const playerSpeed = 1.5; // tweak to feel right
    scene.onBeforeRenderObservable.add(()=>{
        if(!xrHelper.baseExperience.sessionManager.session) return;

        const leftController = xrHelper.input.leftController;
        const rightController = xrHelper.input.rightController;
        if(leftController && rightController){
            const lv = leftController.getLinearVelocity() || BABYLON.Vector3.Zero();
            const rv = rightController.getLinearVelocity() || BABYLON.Vector3.Zero();
            const movement = lv.add(rv).scale(-playerSpeed);
            player.physicsImpostor.applyImpulse(movement, player.getAbsolutePosition());
        }
    });

    engine.runRenderLoop(()=>{
        scene.render();
    });

    window.addEventListener('resize',()=>{engine.resize();});
});
</script>
</body>
</html>
