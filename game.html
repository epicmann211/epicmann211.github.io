<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Gorilla Locomotion WebXR (Fixed Ground)</title>
<style>
  html,body{width:100%;height:100%;margin:0;overflow:hidden}
  canvas{width:100%;height:100%;display:block}
</style>

<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
<script src="https://cdn.babylonjs.com/ammo.js"></script>
</head>
<body>
<canvas id="canvas"></canvas>

<script>
(async function(){
  const canvas = document.getElementById("canvas");
  const engine = new BABYLON.Engine(canvas, true);
  const scene = new BABYLON.Scene(engine);

  // Light
  new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0,1,0), scene);

  // Load Ammo physics first
  await Ammo();
  const physics = new BABYLON.AmmoJSPlugin(true, Ammo);
  scene.enablePhysics(new BABYLON.Vector3(0,-9.81,0), physics);

  // --------------------------------------------------------------------------------
  // REAL GROUND (the environment ground breaks physics sometimes)
  // --------------------------------------------------------------------------------
  const ground = BABYLON.MeshBuilder.CreateBox("ground", {width:50, height:0.2, depth:50}, scene);
  ground.position.y = -0.1;
  ground.material = new BABYLON.StandardMaterial("gm", scene);
  ground.material.diffuseColor = new BABYLON.Color3(0.3,0.7,0.4);

  ground.physicsImpostor = new BABYLON.PhysicsImpostor(
    ground,
    BABYLON.PhysicsImpostor.BoxImpostor,
    { mass:0, friction:1, restitution:0 },
    scene
  );

  // --------------------------------------------------------------------------------
  // PLAYER CAPSULE
  // --------------------------------------------------------------------------------
  const height = 1.2;
  const radius = 0.35;

  let player = BABYLON.MeshBuilder.CreateCapsule("player", {height:height, radius:radius}, scene);
  player.position.y = 1.3;

  player.physicsImpostor = new BABYLON.PhysicsImpostor(
    player,
    BABYLON.PhysicsImpostor.CapsuleImpostor,
    { mass:70, friction:0.2, restitution:0 },
    scene
  );

  // --------------------------------------------------------------------------------
  // WebXR
  // --------------------------------------------------------------------------------
  const xr = await scene.createDefaultXRExperienceAsync();
  if (xr.teleportation) xr.teleportation.dispose();
  if (xr.pointerSelection) xr.pointerSelection.detach();

  let L = null, R = null;
  let lastL = null, lastR = null;

  xr.input.onControllerAddedObservable.add(c=>{
    if (c.inputSource.handedness==="left") L=c;
    if (c.inputSource.handedness==="right") R=c;
  });

  xr.input.onControllerRemovedObservable.add(c=>{
    if (c===L){ L=null; lastL=null; }
    if (c===R){ R=null; lastR=null; }
  });

  function posOf(ctrl){
    if (!ctrl) return null;
    if (ctrl.grip) return ctrl.grip.getAbsolutePosition();
    if (ctrl.rootMesh) return ctrl.rootMesh.getAbsolutePosition();
    return null;
  }

  const IMPULSE = 2.2;

  scene.onBeforeRenderObservable.add(()=>{
    if (xr.baseExperience.state !== BABYLON.WebXRState.IN_XR) return;

    let move = new BABYLON.Vector3();

    const pL = posOf(L);
    const pR = posOf(R);

    if (pL){
      if (lastL){
        move.addInPlace(pL.subtract(lastL).scale(IMPULSE));
      }
      lastL = pL.clone();
    }
    if (pR){
      if (lastR){
        move.addInPlace(pR.subtract(lastR).scale(IMPULSE));
      }
      lastR = pR.clone();
    }

    move.y = 0;

    player.physicsImpostor.applyImpulse(
      move,
      player.getAbsolutePosition()
    );

    const cam = xr.baseExperience.camera;
    cam.position = player.getAbsolutePosition().add(new BABYLON.Vector3(0,height/2,0));
  });

  engine.runRenderLoop(()=>scene.render());
})();
</script>

</body>
</html>
